1. subelesme.md
# ÅubeleÅŸme (Multi-Tenant) Ä°ÅŸ Modeli â€” SRC & Ehliyet Otomasyon

Bu dokÃ¼man, sistemdeki ÅŸubeleÅŸme mantÄ±ÄŸÄ±nÄ± aÃ§Ä±klar.  
Teknik detaylar diÄŸer dosyalardadÄ±r (db.md, guvenlik.md, frontend.md).

---

## 1. Åube (Tenant) Nedir?

Sistemi kullanan her kurs/ÅŸube baÄŸÄ±msÄ±z bir tenantâ€™tÄ±r.

Ã–rnek:
- Mavi-Beyaz Akademi
- Duru SRC
- YÄ±ldÄ±z SÃ¼rÃ¼cÃ¼ Kursu

Her ÅŸubenin kendine ait Ã¶ÄŸrencisi, kurslarÄ±, yoklamalarÄ±, belgeleri vardÄ±r.

---

## 2. TenantId (Åube Kodu)

Her ÅŸube, sistemde **string bir kod** ile temsil edilir:

Ã–rnek:
- `MAVI-BEYAZ-AKADEMI`
- `DURU-AKADEMI`

Bu kod **veritabanÄ±ndaki her kaydÄ±** birbirinden ayÄ±rÄ±r.

---

## 3. Åube Root KullanÄ±cÄ±sÄ± (BranchAdmin)

Her yeni ÅŸube eklediÄŸimizde sistem:

- 1 adet **ÅŸube root kullanÄ±cÄ±sÄ±** oluÅŸturur.
- Username â†’ kursun adÄ± bazlÄ± olur:

Ã–r:
- Kurs adÄ±: `Mavi-Beyaz Akademi`
- Username: `mavi-beyaz.akademi`
- TenantId: `MAVI-BEYAZ-AKADEMI`
- Role: `BranchAdmin`

Bu kullanÄ±cÄ±:
- Kendi ÅŸubesini yÃ¶netir
- Ã–ÄŸretmen, operatÃ¶r gibi kullanÄ±cÄ±lar oluÅŸturabilir
- Sadece kendi ÅŸubesinin verilerini gÃ¶rÃ¼r

---

## 4. Ãœst YÃ¶netim (HQ Â· PlatformOwner)

Sistemi yÃ¶neten taraf:

- TÃ¼m ÅŸubeleri gÃ¶rÃ¼r
- Her ÅŸubenin kullanÄ±m istatistiklerine eriÅŸir
- Yeni ÅŸube oluÅŸturabilir
- Åubeleri aktif/pasif yapabilir

Rol adÄ±: `PlatformOwner`

UI rotalarÄ±:
- `/hq/dashboard`
- `/hq/tenants`
- `/hq/usage`

---

## 5. Yeni Åube Ekleme AkÄ±ÅŸÄ±

1. HQ panelinden â€œYeni Åube Ekleâ€ seÃ§ilir
2. Tenant kaydÄ± eklenir
3. Root kullanÄ±cÄ± oluÅŸturulur:
   - Username: kursadÄ±.benzeri
   - Password: baÅŸlangÄ±Ã§ ÅŸifresi
   - Role: BranchAdmin
4. KullanÄ±cÄ±ya giriÅŸ bilgileri verilir

---

## 6. Sistem Ä°Ã§indeki GÃ¶rÃ¼nÃ¼rlÃ¼k

### Åube KullanÄ±cÄ±sÄ±
- Sadece kendi TenantIdâ€™sini gÃ¶rÃ¼r

### HQ KullanÄ±cÄ±sÄ±
- TÃ¼m tenantâ€™larÄ± gÃ¶rÃ¼r
- KullanÄ±m raporlarÄ± alabilir

---

Bu dosya, sistemde ÅŸubeleÅŸmenin iÅŸ mantÄ±ÄŸÄ±nÄ± tanÄ±mlar.  
Teknik uygulama iÃ§in: db.md + guvenlik.md + frontend.md dosyalarÄ±na bakÄ±nÄ±z.

ğŸ“Œ 2. db.md
# VeritabanÄ± TasarÄ±mÄ± â€” Multi-Tenant (ÅubeleÅŸme)

Bu dosya **veritabanÄ±** tarafÄ±nda ÅŸubeleÅŸmenin nasÄ±l uygulanacaÄŸÄ±nÄ± aÃ§Ä±klar.

---

## 1. Tenant Tablosu

```csharp
public class Tenant
{
    public string Id { get; set; } = default!;      // MAVI-BEYAZ-AKADEMI
    public string Name { get; set; } = default!;    // Mavi-Beyaz Akademi
    public string? City { get; set; }
    public bool IsActive { get; set; } = true;
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
}


DBSet:

public DbSet<Tenant> Tenants => Set<Tenant>();

2. UserTenant (KullanÄ±cÄ±â€“Åube Ä°liÅŸkisi)
public class UserTenant
{
    public Guid Id { get; set; } = Guid.NewGuid();
    public Guid UserId { get; set; }
    public string TenantId { get; set; } = default!;

    public User? User { get; set; }
    public Tenant? Tenant { get; set; }
}

3. TenantEntity Base Class

TÃ¼m ÅŸubeye baÄŸlÄ± tablolar bu sÄ±nÄ±ftan tÃ¼retilir:

public abstract class TenantEntity
{
    public Guid Id { get; set; } = Guid.NewGuid();
    public string TenantId { get; set; } = default!;
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime? UpdatedAt { get; set; }
}

4. EF Core Global Query Filter
builder.Entity<TEntity>().HasQueryFilter(e => e.TenantId == _tenantProvider.TenantId);


Bu sayede:

SELECT * FROM Students
WHERE TenantId = 'MAVI-BEYAZ-AKADEMI'


otomatik eklenir.

5. Index Tavsiyeleri
Ã–ÄŸrenciler
.HasIndex(x => new { x.TenantId, x.NationalId }).IsUnique();

Kurslar
.HasIndex(x => new { x.TenantId, x.CourseClassId });

Yoklama
.HasIndex(x => new { x.TenantId, x.CourseId, x.SessionAt });

6. HQ Query'leri (TÃ¼m Tenantâ€™larÄ± GÃ¶rebilen)
_db.Students.IgnoreQueryFilters()
    .GroupBy(x => x.TenantId)
    .Select(g => new { TenantId = g.Key, Count = g.Count() })
    .ToListAsync();


Bu sadece PlatformOwner rolÃ¼nde kullanÄ±lmalÄ±dÄ±r.

Bu dosya, ÅŸubeleÅŸmenin veritabanÄ± tasarÄ±mÄ±nÄ± tamamlar.


---

# ğŸ“Œ 3. **guvenlik.md**

```md
# GÃ¼venlik Â· JWT + X-TenantId + Middleware

Bu dokÃ¼man, multi-tenant yapÄ±nÄ±n gÃ¼venlik tarafÄ±nÄ± aÃ§Ä±klar.

---

## 1. JWT Ä°Ã§eriÄŸi

Token iÃ§inde ÅŸu claimâ€™ler olmalÄ±:

- sub â†’ UserId
- role â†’ PlatformOwner / BranchAdmin / Teacher / Operator / Student
- tenantId (tek ÅŸube)
- tenants (Ã§ok ÅŸube)

---

## 2. Zorunlu Header: X-TenantId

Her API isteÄŸinde olmalÄ±:



X-TenantId: MAVI-BEYAZ-AKADEMI


---

## 3. TenantMiddleware

YapmasÄ± gerekenler:

1. Headerâ€™dan TenantId oku  
2. Header yoksa â†’ 400  
3. JWTâ€™den userâ€™Ä±n yetkili yazÄ±lÄ± tenantâ€™larÄ±nÄ± Ã§ek  
4. Header tenant listede yoksa â†’ 403  
5. `ITenantProvider.SetTenant(tenantId)` Ã§aÄŸÄ±r  

Bu tÃ¼m sistemin gÃ¼venlik temelidir.

---

## 4. Rol BazlÄ± EriÅŸim

Åube ekranlarÄ±:
```csharp
[Authorize(Roles = "BranchAdmin,Teacher,Operator")]


HQ ekranlarÄ±:

[Authorize(Roles = "PlatformOwner")]

5. ProblemDetails FormatÄ±

400 / 401 / 403 hatalarÄ±nda:

{
  "title": "Tenant access denied",
  "detail": "You are not allowed to access this tenant.",
  "status": 403
}

6. Hangfireâ€™e Tenant Enjeksiyonu

Job parametresine tenantId eklenir:

public Task SendReminder(string tenantId, Guid reminderId)


Ä°lk satÄ±r:

_tenantProvider.SetTenant(tenantId);


Bu dosya, multi-tenant gÃ¼venlik modelini tamamlar.


---

# ğŸ“Œ 4. **frontend.md**

```md
# Frontend (Next.js) Â· Åube SeÃ§imi & HQ EkranÄ±

Bu dokÃ¼man frontend tarafÄ±ndaki ÅŸubeleÅŸme yapÄ±sÄ±nÄ± aÃ§Ä±klar.

---

## 1. API Client Â· X-TenantId GÃ¶nderimi

`lib/api.ts` iÃ§inde:

```ts
api.interceptors.request.use((config) => {
  const token = localStorage.getItem("token");
  const tenantId = localStorage.getItem("tenantId");

  if (token) config.headers.Authorization = `Bearer ${token}`;
  if (tenantId) config.headers["X-TenantId"] = tenantId;

  return config;
});

2. Login AkÄ±ÅŸÄ±

Login sonrasÄ± backend:

token

role

tenantId veya tenants

dÃ¶ndÃ¼rÃ¼r.

Frontend:

localStorage.setItem("token", token);
localStorage.setItem("tenantId", defaultTenantId);

3. Tenant Switcher (Åube DeÄŸiÅŸtirici)

components/tenant/TenantSwitcher.tsx:

KullanÄ±cÄ±nÄ±n yetkili olduÄŸu tenantâ€™larÄ± /api/tenants/myâ€™dan Ã§eker

Dropdown olarak gÃ¶sterir

SeÃ§ildiÄŸinde:

localStorage.setItem("tenantId", selected);
window.location.reload();

4. HQ (PlatformOwner) UI

Route tasarÄ±mÄ±:

app/
  (hq)/
    hq/
      dashboard/page.tsx
      tenants/page.tsx
      usage/page.tsx


Bu sayfalar

[Authorize(Roles = "PlatformOwner")]


korumasÄ±ndadÄ±r.

5. KullanÄ±m EkranÄ± Ã–rneÄŸi

GET /api/hq/tenants/usage verisi ile:

Her ÅŸube

Ã–ÄŸrenci sayÄ±sÄ±

Aktif kurs sayÄ±sÄ±

Son giriÅŸ zamanÄ±

gÃ¶sterilir.