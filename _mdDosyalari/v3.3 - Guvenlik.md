ğŸ“Œ 3. Dosya â€” guvenlik.md
# GÃ¼venlik TasarÄ±mÄ± â€” JWT Â· X-TenantId Â· TenantMiddleware

Bu dokÃ¼man Ã§ok ÅŸubeli (multi-tenant) yapÄ±da gÃ¼venlik, kimlik doÄŸrulama ve yetkilendirme mekanizmasÄ±nÄ± aÃ§Ä±klar.

---

# 1. JWT Ä°Ã§eriÄŸi

Login sonrasÄ± verilen token iÃ§inde mutlaka aÅŸaÄŸÄ±daki claimâ€™ler olmalÄ±dÄ±r:

## ğŸ”¸ Tek ÅŸubeli kullanÄ±cÄ± iÃ§in:
```json
{
  "sub": "USER_ID",
  "email": "mavi-beyaz.akademi",
  "role": "BranchAdmin",
  "tenantId": "MAVI-BEYAZ-AKADEMI"
}

ğŸ”¸ Ã‡ok ÅŸubeli kullanÄ±cÄ± iÃ§in:
{
  "sub": "USER_ID",
  "email": "global@admin",
  "role": "PlatformOwner",
  "tenants": "MAVI-BEYAZ-AKADEMI,DURU-AKADEMI"
}


Token iÃ§inde:

role â†’ hangi eriÅŸim seviyesinde olduÄŸunu belirler

tenantId veya tenants â†’ hangi ÅŸubelere eriÅŸebileceÄŸini belirler

2. X-TenantId Header (ZORUNLU)

Her API isteÄŸinde olmalÄ±:

X-TenantId: MAVI-BEYAZ-AKADEMI


EÄŸer yoksa â†’ 400 Bad Request
Veya userâ€™Ä±n yetkili olduÄŸu tenant listesinde yoksa â†’ 403 Forbidden

3. TenantMiddleware

TÃ¼m istekleri ÅŸube bazÄ±nda doÄŸrulayan kritik middleware.

YapmasÄ± gerekenler:

Request headerâ€™dan X-TenantId al

EÄŸer yoksa:

400 Bad Request + ProblemDetails dÃ¶n

KullanÄ±cÄ± login ise:

JWT iÃ§indeki tenantId/tenants ile karÅŸÄ±laÅŸtÄ±r

EriÅŸim yoksa 403 Forbidden dÃ¶n

EriÅŸim uygunsa:

ITenantProvider.SetTenant(tenantId) Ã§aÄŸÄ±r

Request'i devam ettir

Ã–rnek Middleware:
public class TenantMiddleware
{
    private readonly RequestDelegate _next;

    public TenantMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task InvokeAsync(HttpContext context, ITenantProvider provider)
    {
        if (!context.Request.Headers.TryGetValue("X-TenantId", out var tenantId))
        {
            context.Response.StatusCode = StatusCodes.Status400BadRequest;
            await context.Response.WriteAsJsonAsync(new ProblemDetails
            {
                Title = "TenantId missing",
                Detail = "X-TenantId header is required.",
                Status = 400
            });
            return;
        }

        var user = context.User;
        if (user?.Identity?.IsAuthenticated == true)
        {
            var allowedTenants = GetUserTenants(user);

            if (allowedTenants.Length > 0 &&
                !allowedTenants.Contains(tenantId.ToString(), StringComparer.OrdinalIgnoreCase))
            {
                context.Response.StatusCode = StatusCodes.Status403Forbidden;
                await context.Response.WriteAsJsonAsync(new ProblemDetails
                {
                    Title = "Access denied",
                    Detail = "You are not allowed to access this tenant.",
                    Status = 403
                });
                return;
            }
        }

        provider.SetTenant(tenantId!);

        await _next(context);
    }

    private string[] GetUserTenants(ClaimsPrincipal user)
    {
        var single = user.FindFirst("tenantId")?.Value;
        var multiple = user.FindFirst("tenants")?.Value;

        if (!string.IsNullOrWhiteSpace(multiple))
            return multiple.Split(',', StringSplitOptions.TrimEntries);

        if (!string.IsNullOrWhiteSpace(single))
            return new[] { single };

        return Array.Empty<string>();
    }
}


Program.cs:

app.UseAuthentication();
app.UseMiddleware<TenantMiddleware>();
app.UseAuthorization();

4. Rol BazlÄ± Yetkilendirme
ğŸ”¸ Åube iÃ§in kullanÄ±lan roller:

BranchAdmin

Teacher

Operator

[Authorize(Roles = "BranchAdmin,Teacher,Operator")]

ğŸ”¸ HQ iÃ§in kullanÄ±lan rol:

PlatformOwner

[Authorize(Roles = "PlatformOwner")]

5. ProblemDetails FormatÄ±

TÃ¼m hata yanÄ±tlarÄ±:

{
  "title": "Tenant access denied",
  "detail": "You are not allowed to access this tenant.",
  "status": 403
}

6. Hangfire Ä°ÅŸlerinde Tenant BaÄŸÄ±

Her Scheduled job ÅŸu formatta olmalÄ±:

BackgroundJob.Enqueue(() => SendReminder("MAVI-BEYAZ-AKADEMI", courseId));


Job baÅŸlangÄ±cÄ±nda:

_tenantProvider.SetTenant(tenantId);


Bu sayede EF Core global filtre doÄŸru tenantâ€™a geÃ§er.

Ã–zet

JWT iÃ§inde tenant bilgisi tutulur

X-TenantId zorunlu headerâ€™dÄ±r

TenantMiddleware eriÅŸim kontrolÃ¼nÃ¼ yapar

Åube kullanÄ±cÄ±larÄ± sadece kendi ÅŸubesini gÃ¶rÃ¼r

PlatformOwner tÃ¼m ÅŸubeleri gÃ¶rebilir

Hangfire gÃ¶revleri tenantId ile Ã§alÄ±ÅŸÄ±r

Bu dosya, sistemin gÃ¼venlik & tenant doÄŸrulama katmanÄ±nÄ± tamamen tanÄ±mlar.


---

# ğŸ“Œ **4. Dosya â€” `frontend.md`**

```md
# Frontend TasarÄ±mÄ± â€” Next.js Â· Åube SeÃ§imi Â· HQ Paneli

Bu dokÃ¼man, multi-tenant yapÄ±nÄ±n Next.js frontend tarafÄ±ndaki uygulamasÄ±nÄ± aÃ§Ä±klar.

---

# 1. API Client â€“ X-TenantId & JWT Header

`frontend/lib/api.ts` dosyasÄ±:

```ts
import axios from "axios";

const api = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_BASE,
});

api.interceptors.request.use((config) => {
  const token = localStorage.getItem("token");
  const tenantId = localStorage.getItem("tenantId");

  if (token) config.headers.Authorization = `Bearer ${token}`;
  if (tenantId) config.headers["X-TenantId"] = tenantId;

  return config;
});

export default api;


Bu yapÄ±:

Her istekte token gÃ¶nderir

SeÃ§ili tenantIdâ€™yi gÃ¶nderir

2. Login AkÄ±ÅŸÄ±

Backend login, ÅŸu bilgileri dÃ¶ner:

{
  "token": "JWT_TOKEN",
  "role": "BranchAdmin",
  "tenantId": "MAVI-BEYAZ-AKADEMI",
  "tenants": []
}


Frontend:

localStorage.setItem("token", token);
localStorage.setItem("tenantId", tenantId);


EÄŸer HQ ise:

if (role === "PlatformOwner") router.push("/hq/dashboard");
else router.push("/");

3. TenantSwitcher (Åube DeÄŸiÅŸtirici)

GET /api/tenants/my â†’ KullanÄ±cÄ±nÄ±n yetkili olduÄŸu ÅŸubeleri dÃ¶ner.

BileÅŸen:

"use client";

import { useEffect, useState } from "react";
import api from "@/lib/api";

export default function TenantSwitcher() {
  const [tenants, setTenants] = useState([]);
  const [current, setCurrent] = useState("");

  useEffect(() => {
    const stored = localStorage.getItem("tenantId");
    if (stored) setCurrent(stored);

    api.get("/api/tenants/my").then((res) => setTenants(res.data));
  }, []);

  const changeTenant = (tenant: string) => {
    localStorage.setItem("tenantId", tenant);
    setCurrent(tenant);
    window.location.reload();
  };

  if (!tenants.length) return null;

  return (
    <select
      className="border px-2 py-1 rounded text-sm"
      value={current}
      onChange={(e) => changeTenant(e.target.value)}
    >
      {tenants.map((t: any) => (
        <option key={t.id} value={t.id}>
          {t.name}
        </option>
      ))}
    </select>
  );
}


YerleÅŸtirileceÄŸi yer:
ğŸ‘‰ dashboard layoutâ€™un saÄŸ Ã¼stÃ¼

4. HQ Paneli (PlatformOwner)

Rota yapÄ±sÄ±:

app/
  (hq)/
    hq/
      dashboard/page.tsx
      tenants/page.tsx
      usage/page.tsx


Bu rotalar sadece HQ kullanÄ±cÄ±larÄ±nÄ±n gÃ¶rÃ¼ntÃ¼lemesi iÃ§in tasarlanmÄ±ÅŸtÄ±r.

Ã–rnek ekran:

dashboard/page.tsx
"use client";

import api from "@/lib/api";
import { useEffect, useState } from "react";

export default function HqDashboard() {
  const [data, setData] = useState([]);

  useEffect(() => {
    api.get("/api/hq/tenants/usage").then((res) => setData(res.data));
  }, []);

  return (
    <div className="space-y-4">
      <h1 className="text-xl font-semibold">HQ â€” Åube KullanÄ±m Ã–zeti</h1>

      <table className="min-w-full text-sm border">
        <thead>
          <tr className="bg-muted">
            <th className="border px-2 py-1">Åube</th>
            <th className="border px-2 py-1">Ã–ÄŸrenci</th>
            <th className="border px-2 py-1">Aktif Kurs</th>
            <th className="border px-2 py-1">Son GiriÅŸ</th>
          </tr>
        </thead>
        <tbody>
          {data.map((t: any) => (
            <tr key={t.tenantId}>
              <td className="border px-2 py-1">{t.tenantName}</td>
              <td className="border px-2 py-1 text-right">{t.totalStudents}</td>
              <td className="border px-2 py-1 text-right">{t.activeCourses}</td>
              <td className="border px-2 py-1">
                {t.lastLoginAt ? new Date(t.lastLoginAt).toLocaleString() : "-"}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}

5. KullanÄ±cÄ± Deneyimi AkÄ±ÅŸÄ±
1) KullanÄ±cÄ± giriÅŸ yapar

Backend token + role + tenantId dÃ¶ner.

2) Frontend:

token kaydedilir

tenantId kaydedilir

kullanÄ±cÄ± kendi ÅŸubesine yÃ¶nlendirilir

3) Dashboard ekranÄ±nda tenant switcher gÃ¶zÃ¼kÃ¼r

KullanÄ±cÄ± ÅŸube deÄŸiÅŸtirirse â†’ sayfa yenilenir

4) HQ kullanÄ±cÄ±larÄ± /hq/* rotalarÄ±na yÃ¶nlendirilir

Åubeleri topluca gÃ¶rÃ¼r

KullanÄ±m istatistiklerini inceler

Ã–zet

TÃ¼m API isteklerinde token + X-TenantId otomatik gider

KullanÄ±cÄ± yalnÄ±zca kendi ÅŸubesini gÃ¶rÃ¼r

HQ kullanÄ±cÄ±larÄ± tÃ¼m ÅŸubeleri gÃ¶rebilir

TenantSwitcher ÅŸubeler arasÄ± geÃ§iÅŸi saÄŸlar

/hq/dashboard HQ pano ekranÄ±dÄ±r

Bu dosya, frontend tarafÄ±ndaki tÃ¼m tenant mimarisini tamamlar.