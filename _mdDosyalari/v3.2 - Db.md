ğŸ“Œ db.md (Tek ve Eksiksiz Dosya)
# VeritabanÄ± TasarÄ±mÄ± â€” Multi-Tenant (ÅubeleÅŸme) Modeli

Bu dosya, SRC & Ehliyet Otomasyon Sisteminde **tek veritabanÄ±** Ã¼zerinde Ã§ok ÅŸubeli yapÄ±yÄ± (multi-tenant) nasÄ±l uygulayacaÄŸÄ±mÄ±zÄ± anlatÄ±r.

AmaÃ§:
- Her ÅŸubenin verisini `TenantId` ile ayÄ±rmak  
- Mevcut iskelete zarar vermeden geniÅŸletmek  
- EF Core ile otomatik ÅŸube filtresi kullanmak  
- HQ (PlatformOwner) raporlarÄ± iÃ§in filtreleri bypass edebilmek

---

# 1. Tenant (Åube) Tablosu

Her ÅŸubenin sistemde bir karÅŸÄ±lÄ±ÄŸÄ± olmalÄ±.

```csharp
public class Tenant
{
    public string Id { get; set; } = default!;      // Ã–r: "MAVI-BEYAZ-AKADEMI"
    public string Name { get; set; } = default!;    // Ã–r: "Mavi-Beyaz Akademi"
    public string? City { get; set; }               // Opsiyonel
    public bool IsActive { get; set; } = true;
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
}


DbContext:

public DbSet<Tenant> Tenants => Set<Tenant>();

2. UserTenant â€” KullanÄ±cÄ± ile Åube BaÄŸÄ±

Bir kullanÄ±cÄ±:

Tek ÅŸubeye baÄŸlÄ± olabilir

Birden fazla ÅŸubeye baÄŸlÄ± olabilir

HQ ise tÃ¼m ÅŸubelere eriÅŸebilir

Bu iliÅŸkiyi ÅŸu tablo kurar:

public class UserTenant
{
    public Guid Id { get; set; } = Guid.NewGuid();
    public Guid UserId { get; set; }
    public string TenantId { get; set; } = default!;

    public User? User { get; set; }
    public Tenant? Tenant { get; set; }
}


DbContext iliÅŸkilendirmesi:

modelBuilder.Entity<UserTenant>()
    .HasIndex(x => new { x.UserId, x.TenantId })
    .IsUnique();

modelBuilder.Entity<UserTenant>()
    .HasOne(ut => ut.User)
    .WithMany()
    .HasForeignKey(ut => ut.UserId);

modelBuilder.Entity<UserTenant>()
    .HasOne(ut => ut.Tenant)
    .WithMany()
    .HasForeignKey(ut => ut.TenantId);

3. TenantEntity â€” TÃ¼m Veri Modellerine TenantId Ekleme

Sistemde ÅŸubeye baÄŸlÄ± olan bÃ¼tÃ¼n tablolar, ÅŸu baz sÄ±nÄ±ftan tÃ¼retilir:

public abstract class TenantEntity
{
    public Guid Id { get; set; } = Guid.NewGuid();
    public string TenantId { get; set; } = default!;
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime? UpdatedAt { get; set; }
}


Åu modeller bu sÄ±nÄ±ftan tÃ¼retilmeli:

Student

Course

CourseClass

Enrollment

Attendance

Document

(Varsa) Payment, Invoice, ExamSession vb.

Ã–rnek:

public class Student : TenantEntity
{
    public string FullName { get; set; } = default!;
    public string NationalId { get; set; } = default!;
}

4. VeritabanÄ±na TenantId Migration Ekleme

Yeni migration adÄ±:

Add_TenantSupport


Migration iÅŸlemleri:

TÃ¼m TenantEntity tÃ¼revi tablolara TenantId kolonu ekle (nvarchar(64) veya varchar(64))

NOT NULL yap

Eski veriler varsa default deÄŸer ata:

Migration iÃ§indeki Up:

Sql("UPDATE Students SET TenantId = 'MAIN' WHERE TenantId IS NULL;");
Sql("UPDATE Courses SET TenantId = 'MAIN' WHERE TenantId IS NULL;");
Sql("UPDATE Attendance SET TenantId = 'MAIN' WHERE TenantId IS NULL;");
-- diÄŸer tablolar iÃ§in de aynÄ±sÄ±

5. EF Core Global Query Filter â€” TÃ¼m Sorgulara Otomatik Åube Filtresi
builder.Entity<TEntity>()
    .HasQueryFilter(e => e.TenantId == _tenantProvider.TenantId);


Tam implementasyon:

private readonly ITenantProvider _tenantProvider;

public AppDbContext(DbContextOptions<AppDbContext> options, ITenantProvider tenantProvider) 
    : base(options)
{
    _tenantProvider = tenantProvider;
}

protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    base.OnModelCreating(modelBuilder);

    foreach (var entityType in modelBuilder.Model.GetEntityTypes())
    {
        if (typeof(TenantEntity).IsAssignableFrom(entityType.ClrType))
        {
            var method = typeof(AppDbContext)
                .GetMethod(nameof(ApplyTenantFilter), BindingFlags.NonPublic | BindingFlags.Instance)!
                .MakeGenericMethod(entityType.ClrType);

            method.Invoke(this, new object[] { modelBuilder });
        }
    }

    ConfigureIndexes(modelBuilder);
}

private void ApplyTenantFilter<TEntity>(ModelBuilder builder) where TEntity : TenantEntity
{
    builder.Entity<TEntity>().HasQueryFilter(e => e.TenantId == _tenantProvider.TenantId);
}


Bu filter sayesinde:

_db.Students.ToListAsync();


otomatik ÅŸu olur:

SELECT * FROM Students
WHERE TenantId = '{Aktif Åube}'

6. Performans Ä°Ã§in Ã–nerilen Indexâ€™ler
Ã–ÄŸrenciler:
.HasIndex(x => new { x.TenantId, x.NationalId }).IsUnique();
.HasIndex(x => new { x.TenantId, x.CreatedAt });

Kurslar:
.HasIndex(x => new { x.TenantId, x.CourseClassId });
.HasIndex(x => new { x.TenantId, x.StartDate });
.HasIndex(x => new { x.TenantId, x.MebApprovalStatus });

Yoklama:
.HasIndex(x => new { x.TenantId, x.CourseId, x.SessionAt });

Belgeler:
.HasIndex(x => new { x.TenantId, x.ExpireDate });

7. HQ (PlatformOwner) Ä°Ã§in Tenant Filtre Bypass

HQ kullanÄ±cÄ±sÄ± tÃ¼m ÅŸubeleri gÃ¶rebilir. Bunun iÃ§in:

SeÃ§enek 1 â€” IgnoreQueryFilters()
var list = await _db.Students
    .IgnoreQueryFilters()
    .GroupBy(x => x.TenantId)
    .Select(g => new { TenantId = g.Key, Count = g.Count() })
    .ToListAsync();

SeÃ§enek 2 â€” AyrÄ± bir â€œfilterâ€™sÄ±zâ€ DbContext (opsiyonel)

Sadece HQ endpointlerinde kullanÄ±lÄ±r.

8. KÄ±sa Ã–zet

Tek veritabanÄ± kullanÄ±lÄ±r

TÃ¼m tablolarda TenantId ile veri ayrÄ±lÄ±r

Tenant ve UserTenant tablolarÄ± ÅŸube yÃ¶netimini saÄŸlar

Global Query Filter tÃ¼m ÅŸubelerin verisini birbirinden ayÄ±rÄ±r

PlatformOwner filtreyi bypass ederek rapor alÄ±r

Indexâ€™ler performansÄ± garanti eder

Bu dosya, ÅŸubeleÅŸme yapÄ±sÄ±nÄ±n veritabanÄ± temelini oluÅŸturur.