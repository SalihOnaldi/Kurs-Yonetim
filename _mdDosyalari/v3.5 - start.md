# SRC & Ehliyet Otomasyon — Multi-Tenant (Şubeleşme) + Güvenlik + Frontend Genişleme Talimatı

Sen, mevcut bir SRC & Ehliyet Otomasyon projesini GENİŞLETEN yardımcı geliştiricisin.

## Proje Özeti (değiştirme):
- Backend: .NET 8 + ASP.NET Core Web API + EF Core (code-first) + JWT + Hangfire + MinIO
- Frontend: Next.js 15 + React 18 + TypeScript + Tailwind + shadcn/ui
- Veritabanı: Tek relational DB (PostgreSQL veya SQL Server)

## Kritik Kurallar:
- Mevcut dosyaları **SİLME**.
- Mevcut dosyaları **tamamen EZME** (overwrite) — sadece gereken kısımlara ekleme/ufak güncelleme yap.
- Mimariyi bozma; sadece aşağıdaki dört bölümde anlatılan yapıları **non-destructive** şekilde ekle:
  1. Şube İş Modeli (Şubeleşme)
  2. Veritabanı (DB) Katmanı
  3. Güvenlik (JWT + X-TenantId + Middleware)
  4. Frontend (Login, Şube Switcher, HQ Paneli)

Aşağıdaki 4 bölümü **sırayla** uygula.

---

## 1) ŞUBELEŞME (İŞ MODELİ) — “Şube / Tenant” Mantığı

### 1.1 Şube (Tenant) Tanımı
- Sistemi kullanan her kurs/merkez bir **şube (tenant)** olsun.
  - Örn: `Mavi-Beyaz Akademi`, `Duru SRC`, `Yıldız Sürücü Kursu`
- Bu şubeler, teknik tarafta **string TenantId** ile temsil edilecek:
  - `MAVI-BEYAZ-AKADEMI`
  - `DURU-AKADEMI`
  - `YILDIZ-SRC`

Bu TenantId, veritabanındaki her kaydı **hangi şubeye ait** olduğunu göstermek için kullanılacak.

### 1.2 Şube Root Kullanıcısı (BranchAdmin)
Her yeni şube açıldığında:
- Bir **root kullanıcı** oluştur:
  - Username: kurs adı bazlı → `mavi-beyaz.akademi`
  - Role: `BranchAdmin`
  - TenantId: `MAVI-BEYAZ-AKADEMI`

Bu kullanıcı:
- Sadece kendi şubesinin verilerini görür.
- Kendi şubesi için `Teacher`, `Operator` gibi alt kullanıcılar açar.

### 1.3 PlatformOwner (HQ Kullanıcısı)
Yeni bir global rol olsun:
- `PlatformOwner`:
  - Tüm şubeleri (tenant’ları) ve kullanım istatistiklerini görür.
  - Yeni şube (tenant) ekler.
  - Şubeleri aktif/pasif yapar.

Bu rol için ileride özel HQ rotaları kullanılacak:
- `/hq/dashboard`
- `/hq/tenants`
- `/hq/usage`

> İş modeli:  
> - Şube kullanıcıları (BranchAdmin, Teacher, Operator) → sadece kendi TenantId’lerini görür.  
> - PlatformOwner → tüm TenantId’ler üzerinde rapor ve kontrol ekranları görür.

---

## 2) VERİTABANI (DB) — Tenant, UserTenant, TenantEntity, Global Filter

### 2.1 Tenant Tablosu

Yeni entity oluştur:

```csharp
public class Tenant
{
    public string Id { get; set; } = default!;      // Ör: "MAVI-BEYAZ-AKADEMI"
    public string Name { get; set; } = default!;    // "Mavi-Beyaz Akademi"
    public string? City { get; set; }
    public bool IsActive { get; set; } = true;
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
}
DbContext’e ekle (mevcut yapıyı bozmadan):

csharp
Copy code
public DbSet<Tenant> Tenants => Set<Tenant>();
2.2 UserTenant (Kullanıcı–Şube İlişkisi)
Çoklu şube desteği için ilişki tablosu ekle:

csharp
Copy code
public class UserTenant
{
    public Guid Id { get; set; } = Guid.NewGuid();
    public Guid UserId { get; set; }
    public string TenantId { get; set; } = default!;

    public User? User { get; set; }
    public Tenant? Tenant { get; set; }
}
OnModelCreating içinde:

csharp
Copy code
modelBuilder.Entity<UserTenant>()
    .HasIndex(x => new { x.UserId, x.TenantId })
    .IsUnique();

modelBuilder.Entity<UserTenant>()
    .HasOne(ut => ut.User)
    .WithMany()
    .HasForeignKey(ut => ut.UserId);

modelBuilder.Entity<UserTenant>()
    .HasOne(ut => ut.Tenant)
    .WithMany()
    .HasForeignKey(ut => ut.TenantId);
2.3 TenantEntity Base Class ve TenantId Kolonu
Şubeye bağlı veri barındıran tüm tablolar TenantEntity (veya mevcut base class’ın genişletilmiş hali) üzerinden TenantId almalı.

Yeni base class:

csharp
Copy code
public abstract class TenantEntity
{
    public Guid Id { get; set; } = Guid.NewGuid();
    public string TenantId { get; set; } = default!;
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
    public DateTime? UpdatedAt { get; set; }
}
Aşağıdaki entity’leri (mevcut kodu bozmadan) bu base sınıftan türet:

Student

Course

CourseClass

Enrollment

Attendance

Document

(Varsa) Payment, Invoice, ExamSession vb.

Örnek:

csharp
Copy code
public class Student : TenantEntity
{
    public string FullName { get; set; } = default!;
    public string NationalId { get; set; } = default!;
    // diğer alanlar...
}
2.4 TenantId Migration
Yeni migration adı önerisi: Add_TenantSupport

Tüm TenantEntity tablolarına TenantId kolonu ekle (nvarchar(64) / varchar(64)).

NOT NULL yap.

Eski veri varsa, migration içinde Sql(...) ile default değer ata:

csharp
Copy code
Sql("UPDATE Students SET TenantId = 'MAIN' WHERE TenantId IS NULL;");
Sql("UPDATE Courses SET TenantId = 'MAIN' WHERE TenantId IS NULL;");
Sql("UPDATE Attendance SET TenantId = 'MAIN' WHERE TenantId IS NULL;");
-- diğer TenantEntity tabloları için de uygula
2.5 EF Core Global Query Filter — Otomatik Tenant Filtreleme
DbContext’e ITenantProvider enjekte et (3. bölümde tanımlanacak).
Sonra tüm TenantEntity türevlerine global filter uygula:

csharp
Copy code
private readonly ITenantProvider _tenantProvider;

public AppDbContext(DbContextOptions<AppDbContext> options, ITenantProvider tenantProvider)
    : base(options)
{
    _tenantProvider = tenantProvider;
}

protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    base.OnModelCreating(modelBuilder);

    foreach (var entityType in modelBuilder.Model.GetEntityTypes())
    {
        if (typeof(TenantEntity).IsAssignableFrom(entityType.ClrType))
        {
            var method = typeof(AppDbContext)
                .GetMethod(nameof(ApplyTenantFilter), BindingFlags.NonPublic | BindingFlags.Instance)!
                .MakeGenericMethod(entityType.ClrType);

            method.Invoke(this, new object[] { modelBuilder });
        }
    }

    ConfigureTenantIndexes(modelBuilder); // Aşağıda
}

private void ApplyTenantFilter<TEntity>(ModelBuilder builder) where TEntity : TenantEntity
{
    builder.Entity<TEntity>().HasQueryFilter(e => e.TenantId == _tenantProvider.TenantId);
}
Artık:

csharp
Copy code
_db.Students.ToListAsync();
otomatik olarak:

sql
Copy code
SELECT * FROM Students WHERE TenantId = '{aktif şube}'
şeklinde çalışır.

2.6 Performans için Index Önerileri
ConfigureTenantIndexes içinde:

csharp
Copy code
void ConfigureTenantIndexes(ModelBuilder modelBuilder)
{
    modelBuilder.Entity<Student>()
        .HasIndex(x => new { x.TenantId, x.NationalId })
        .IsUnique();

    modelBuilder.Entity<Student>()
        .HasIndex(x => new { x.TenantId, x.CreatedAt });

    modelBuilder.Entity<Course>()
        .HasIndex(x => new { x.TenantId, x.CourseClassId });

    modelBuilder.Entity<Course>()
        .HasIndex(x => new { x.TenantId, x.StartDate });

    modelBuilder.Entity<Course>()
        .HasIndex(x => new { x.TenantId, x.MebApprovalStatus });

    modelBuilder.Entity<Attendance>()
        .HasIndex(x => new { x.TenantId, x.CourseId, x.SessionAt });

    modelBuilder.Entity<Document>()
        .HasIndex(x => new { x.TenantId, x.ExpireDate });
}
2.7 HQ (PlatformOwner) İçin Filtre Bypass
HQ controller’larında (sadece PlatformOwner rolü için):

csharp
Copy code
var usage = await _db.Students
    .IgnoreQueryFilters()
    .GroupBy(x => x.TenantId)
    .Select(g => new { TenantId = g.Key, Count = g.Count() })
    .ToListAsync();
Bu sorguları sadece HQ (PlatformOwner) endpoint’lerinde kullan.

3) GÜVENLİK — JWT, X-TenantId, ITenantProvider, TenantMiddleware
3.1 ITenantProvider
Services/Tenancy/ITenantProvider.cs:

csharp
Copy code
public interface ITenantProvider
{
    string TenantId { get; }
    void SetTenant(string tenantId);
}
Services/Tenancy/TenantProvider.cs:

csharp
Copy code
public class TenantProvider : ITenantProvider
{
    private string? _tenantId;
    public string TenantId => _tenantId ?? throw new InvalidOperationException("TenantId not set");

    public void SetTenant(string tenantId)
    {
        _tenantId = tenantId ?? throw new ArgumentNullException(nameof(tenantId));
    }
}
Program.cs:

csharp
Copy code
builder.Services.AddScoped<ITenantProvider, TenantProvider>();
3.2 JWT İçeriği
Login sonrasında üretilen token’da şu claim’ler bulunmalı:

Tek şubeli kullanıcı:

json
Copy code
{
  "sub": "USER_ID",
  "email": "mavi-beyaz.akademi",
  "role": "BranchAdmin",
  "tenantId": "MAVI-BEYAZ-AKADEMI"
}
Çok şubeli veya HQ kullanıcı:

json
Copy code
{
  "sub": "USER_ID",
  "email": "global@admin",
  "role": "PlatformOwner",
  "tenants": "MAVI-BEYAZ-AKADEMI,DURU-AKADEMI"
}
3.3 X-TenantId Header (ZORUNLU)
Tüm API isteklerinde:

X-TenantId header bulunmalı:

Örn: X-TenantId: MAVI-BEYAZ-AKADEMI

Header yoksa → 400
Header var ama kullanıcı o tenant’a yetkili değilse → 403

3.4 TenantMiddleware
Middleware/TenantMiddleware.cs:

X-TenantId header’ını oku

Yoksa → 400 ProblemDetails

Eğer kullanıcı authenticated ise:

JWT içindeki tenantId veya tenants claim’lerini oku

X-TenantId bu liste içinde değilse → 403 ProblemDetails

Son olarak:

ITenantProvider.SetTenant(tenantId) çağır ve pipeline’a devam et

Örnek:

csharp
Copy code
public class TenantMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<TenantMiddleware> _logger;

    public TenantMiddleware(RequestDelegate next, ILogger<TenantMiddleware> logger)
    {
        _next = next;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context, ITenantProvider tenantProvider)
    {
        if (!context.Request.Headers.TryGetValue("X-TenantId", out var tenantId) ||
            string.IsNullOrWhiteSpace(tenantId))
        {
            context.Response.StatusCode = StatusCodes.Status400BadRequest;
            await context.Response.WriteAsJsonAsync(new ProblemDetails
            {
                Title = "TenantId missing",
                Detail = "X-TenantId header is required.",
                Status = StatusCodes.Status400BadRequest
            });
            return;
        }

        var user = context.User;
        if (user?.Identity?.IsAuthenticated == true)
        {
            var allowedTenants = GetUserTenantsFromClaims(user);

            if (allowedTenants.Length > 0 &&
                !allowedTenants.Contains(tenantId.ToString(), StringComparer.OrdinalIgnoreCase))
            {
                _logger.LogWarning("User {User} tried to access tenant {Tenant} but is not allowed.",
                    user.Identity?.Name, tenantId.ToString());

                context.Response.StatusCode = StatusCodes.Status403Forbidden;
                await context.Response.WriteAsJsonAsync(new ProblemDetails
                {
                    Title = "Tenant access denied",
                    Detail = "You are not allowed to access this tenant.",
                    Status = StatusCodes.Status403Forbidden
                });
                return;
            }
        }

        tenantProvider.SetTenant(tenantId!);
        await _next(context);
    }

    private static string[] GetUserTenantsFromClaims(ClaimsPrincipal user)
    {
        var single = user.FindFirst("tenantId")?.Value;
        var multiple = user.FindFirst("tenants")?.Value;

        if (!string.IsNullOrWhiteSpace(multiple))
            return multiple.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);

        if (!string.IsNullOrWhiteSpace(single))
            return new[] { single };

        return Array.Empty<string>();
    }
}
Program.cs içinde middleware sırası:

csharp
Copy code
app.UseAuthentication();
app.UseMiddleware<TenantMiddleware>();
app.UseAuthorization();
3.5 Rol Bazlı Yetki
Şube tarafı controller’lar:

csharp
Copy code
[Authorize(Roles = "BranchAdmin,Teacher,Operator")]
HQ tarafı controller’lar:

csharp
Copy code
[Authorize(Roles = "PlatformOwner")]
3.6 ProblemDetails Formatı
Hatalar daima JSON ProblemDetails biçiminde dönmeli, örnek:

json
Copy code
{
  "title": "Tenant access denied",
  "detail": "You are not allowed to access this tenant.",
  "status": 403
}
4) FRONTEND — Next.js, API Client, Şube Seçimi, HQ Paneli
4.1 API Client — JWT + X-TenantId Header
frontend/lib/api.ts (varsa genişlet, yoksa oluştur):

ts
Copy code
import axios from "axios";

const api = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_BASE,
});

api.interceptors.request.use((config) => {
  if (typeof window !== "undefined") {
    const token = localStorage.getItem("token");
    const tenantId = localStorage.getItem("tenantId");

    if (token) config.headers.Authorization = `Bearer ${token}`;
    if (tenantId) config.headers["X-TenantId"] = tenantId;
  }

  return config;
});

export default api;
4.2 Login Akışı
Login sayfasında:

Backend’e username/password (ve gerekirse tenantId) ile istek at

Backend aşağıdakileri dönsün:

token

role

tenantId veya tenants

Frontend’te:

ts
Copy code
localStorage.setItem("token", token);
if (tenantId) {
  localStorage.setItem("tenantId", tenantId);
}
Rol bazlı yönlendirme:

ts
Copy code
if (role === "PlatformOwner") router.push("/hq/dashboard");
else router.push("/");
4.3 Kullanıcının Şubeleri — /api/tenants/my
Backend’te bir endpoint olsun:

GET /api/tenants/my

Dönüş: { id: string, name: string }[]

Kullanıcının UserTenant ilişkisine göre sadece yetkili olduğu tenant’ları döndür.

4.4 TenantSwitcher Bileşeni
frontend/components/tenant/TenantSwitcher.tsx:

tsx
Copy code
"use client";

import { useEffect, useState } from "react";
import api from "@/lib/api";

interface TenantDto {
  id: string;
  name: string;
}

export default function TenantSwitcher() {
  const [tenants, setTenants] = useState<TenantDto[]>([]);
  const [current, setCurrent] = useState<string>("");

  useEffect(() => {
    const stored = typeof window !== "undefined" ? localStorage.getItem("tenantId") : "";
    if (stored) setCurrent(stored);

    api
      .get<TenantDto[]>("/api/tenants/my")
      .then((res) => setTenants(res.data))
      .catch(() => {});
  }, []);

  const handleChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
    const val = e.target.value;
    setCurrent(val);
    if (typeof window !== "undefined") {
      localStorage.setItem("tenantId", val);
      window.location.reload(); // basit çözüm, istersen React Query invalidate de kullan
    }
  };

  if (!tenants.length) return null;

  return (
    <select
      value={current}
      onChange={handleChange}
      className="border rounded px-2 py-1 text-sm bg-background"
    >
      {tenants.map((t) => (
        <option key={t.id} value={t.id}>
          {t.name}
        </option>
      ))}
    </select>
  );
}
Dashboard layout’ta (örn. app/(dashboard)/layout.tsx) üst barda sağ tarafa ekle:

tsx
Copy code
import TenantSwitcher from "@/components/tenant/TenantSwitcher";

<header className="h-14 border-b flex items-center justify-between px-4">
  <div className="font-semibold">SRC & Kurs Paneli</div>
  <div className="flex items-center gap-4">
    <TenantSwitcher />
    {/* kullanıcı menüsü vs */}
  </div>
</header>
4.5 HQ Paneli (PlatformOwner için)
Route yapısı (varsa mevcut yapıya uygun dizine koy):

bash
Copy code
app/
  (hq)/
    hq/
      dashboard/page.tsx
      tenants/page.tsx
      usage/page.tsx
dashboard/page.tsx için iskelet:

tsx
Copy code
"use client";

import { useEffect, useState } from "react";
import api from "@/lib/api";

interface TenantUsageDto {
  tenantId: string;
  tenantName: string;
  totalStudents: number;
  activeCourses: number;
  lastLoginAt?: string;
}

export default function HqDashboardPage() {
  const [data, setData] = useState<TenantUsageDto[]>([]);

  useEffect(() => {
    api
      .get<TenantUsageDto[]>("/api/hq/tenants/usage")
      .then((res) => setData(res.data))
      .catch(() => {});
  }, []);

  return (
    <div className="space-y-4">
      <h1 className="text-xl font-semibold">HQ — Şube Kullanım Özeti</h1>
      <table className="min-w-full text-sm border">
        <thead>
          <tr className="bg-muted">
            <th className="px-2 py-1 border">Şube</th>
            <th className="px-2 py-1 border">Öğrenci</th>
            <th className="px-2 py-1 border">Aktif Kurs</th>
            <th className="px-2 py-1 border">Son Giriş</th>
          </tr>
        </thead>
        <tbody>
          {data.map((t) => (
            <tr key={t.tenantId}>
              <td className="px-2 py-1 border">{t.tenantName}</td>
              <td className="px-2 py-1 border text-right">{t.totalStudents}</td>
              <td className="px-2 py-1 border text-right">{t.activeCourses}</td>
              <td className="px-2 py-1 border">
                {t.lastLoginAt ? new Date(t.lastLoginAt).toLocaleString() : "-"}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
Bu endpoint için backend tarafında:

GET /api/hq/tenants/usage

Authorize(Roles = "PlatformOwner")

IgnoreQueryFilters() kullanarak tenant bazlı aggregate döndür

5) SONUNDA RAPOR ETMEN GEREKENLER (Cursor’dan Beklenen Özet)
Bu talimatları uyguladıktan sonra, aşağıdaki bilgileri özet olarak yaz:

Eklenen/sadece genişletilen dosya ve klasörler (Tenant, UserTenant, TenantEntity, TenantMiddleware, TenantSwitcher, HQ sayfaları)

Oluşturulan migration adı (ör: Add_TenantSupport)

Global query filter’ın aktive olduğu doğrulandı mı?

TenantMiddleware ile:

X-TenantId olmadan istek → 400

Yanlış tenant → 403

Doğru tenant → 200

Frontend tarafında:

Login sonrası token + tenantId localStorage’a yazılıyor mu?

TenantSwitcher şube değiştirmeyi sağlıyor mu?

PlatformOwner ile /hq/dashboard açılıyor mu?

Bu dokümandaki tüm adımları mevcut projeyi bozmadan, sadece genişleterek uygula.

yaml
Copy code

--- 

Bunu tek parça olarak Cursor’a verip “Bu talimatlara göre projeyi genişlet” dersen, 4 dosyalık mantığı tek seferde işlemiş olursun.









